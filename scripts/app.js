/*
 Stormpath ID Site v0.6.0
 (c) 2014-2017 Stormpath, Inc. http://stormpath.com
 License: Apache 2.0
*/
"use strict";!function(){angular.module("stormpathIdpApp",["ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/register",{templateUrl:"views/registration.html",controller:"RegistrationCtrl"}).when("/forgot/:retry?",{templateUrl:"views/forgot.html",controller:"ForgotCtrl"}).when("/reset",{templateUrl:"views/reset.html",controller:"ResetCtrl"}).when("/verify",{templateUrl:"views/verify.html",controller:"VerifyCtrl"}).when("/unverified",{templateUrl:"views/unverified.html",controller:"UnverifiedCtrl"}).when("/mfa/setup/:factor?",{templateUrl:"views/mfa-setup.html",controller:"MfaSetupCtrl"}).when("/mfa/verify/:factor?/:firstVerification?",{templateUrl:"views/mfa-verify.html",controller:"MfaVerifyCtrl"}).when("/mfa/redirect/:source?/:jwt?",{templateUrl:"views/mfa-redirect.html",controller:"MfaRedirectCtrl"}).otherwise({redirectTo:"/"})}])}(window),angular.module("stormpathIdpApp").controller("LoginCtrl",["$scope","Stormpath","$window",function(a,b,c){function d(){c.fbAsyncInit=function(){var a=c.FB;a.init({appId:b.getProvider("facebook").clientId,xfbml:!0,status:!0,version:"v2.0"})},function(a,b,c){var d,e=a.getElementsByTagName(b)[0];a.getElementById(c)||(d=a.createElement(b),d.id=c,d.src="//connect.facebook.net/es_LA/sdk.js",e.parentNode.insertBefore(d,e))}(c.document,"script","facebook-jssdk")}function e(){Object.keys(a.errors).map(function(b){a.errors[b]=!1})}function f(b){400===b.status?b.code&&2014===b.code?a.errors.organizationNameKeyInvalid=!0:a.errors.badLogin=!0:404===b.status?a.errors.notFound=!0:b.userMessage||b.message?a.errors.userMessage=b.userMessage||b.message:a.errors.unknown=!0}function g(b){a.submitting=!1,b&&f(b)}function h(a){b.register({providerData:{providerId:"facebook",accessToken:a.authResponse.accessToken}},g)}a.ready=!1,a.canRegister=!1,a.errors={badLogin:!1,notFound:!1,userMessage:!1,unknown:!1,organizationNameKeyRequired:!1,organizationNameKeyInvalid:!1},b.init.then(function(){a.organizationNameKey=b.getOrganizationNameKey(),a.showOrganizationField=b.client.jwtPayload.sof,a.disableOrganizationField=""!==a.organizationNameKey,a.canRegister=!!b.idSiteModel.passwordPolicy,a.providers=b.providers,a.ready=!0,a.hasProviders=a.providers.length>0,b.getProvider("facebook")&&d()});var i=!1;return a.submit=function(){if(e(),a.showOrganizationField&&!a.organizationNameKey)a.errors.organizationNameKeyRequired=!0;else if(a.username&&a.password){a.submitting=!0;var c={login:a.username.trim(),password:a.password.trim()};a.organizationNameKey&&(c.accountStore={nameKey:a.organizationNameKey}),b.client.jwtPayload.ash&&(c.accountStore={href:b.client.jwtPayload.ash}),b.login(c,g)}else a.errors.emailPasswordRequired=!0},a.googleLogin=function(){var a=c.gapi;if(a){e();var d={clientid:b.getProvider("google").clientId,scope:"email",cookiepolicy:"single_host_origin",callback:function(a){!i&&a.status.signed_in&&"PROMPT"===a.status.method&&(i=!0,b.register({providerData:{providerId:"google",accessToken:a.access_token}},g))}};a.auth.signIn(d)}},a.facebookLogin=function(){var a=c.FB;a.login(function(a){"connected"===a.status&&h(a)},{scope:"email"})},a.samlLogin=function(a){b.samlLogin(a.accountStore,g)},a.providerLogin=function(b){var c=b.providerId,d=a[c+"Login"];"function"!=typeof d?console.error("provider login function '"+c+"' is not implemented"):d(b)},a}]),angular.module("stormpathIdpApp").controller("RegistrationCtrl",["$scope",function(a){return a}]),angular.module("stormpathIdpApp").controller("ForgotCtrl",["$scope","Stormpath","$routeParams","$rootScope",function(a,b,c,d){a.sent=!1,a.ready=!1,a.retry=c.retry||!1,a.fields={},d.$on("$locationChangeStart",function(b){a.sent&&b.preventDefault()}),b.init.then(function(){a.organizationNameKey=b.getOrganizationNameKey(),a.showOrganizationField=b.client.jwtPayload.sof,a.disableOrganizationField=""!==a.organizationNameKey,a.ready=!0}),a.submit=function(){a.notFound=!1;var c=Object.keys(a.fields).filter(function(b){return a.fields[b].validate()});if(!(c.length>0)){var d={email:a.fields.email.value.trim()};a.organizationNameKey&&(d.accountStore={nameKey:a.organizationNameKey}),b.client.jwtPayload.ash&&(d.accountStore={href:b.client.jwtPayload.ash}),a.submitting=!0,b.sendPasswordResetEmail(d,function(){a.sent=!0,a.submitting=!1})}}}]),angular.module("stormpathIdpApp").controller("ResetCtrl",["$scope","Stormpath","$location",function(a,b,c){a.status="loading",a.fields={};var d;b.init.then(function(){b.verifyPasswordToken(function(b,e){b?404===b.status?c.path("/forgot/retry"):(a.status="failed",a.error=b.userMessage||b):(a.status="verified",d=e)})}),a.submit=function(){var c=Object.keys(a.fields).filter(function(b){var c=a.fields[b];return c.validate()}).length;if(!(c>0)){var e=a.fields.password.value;a.submitting=!0,b.setNewPassword(d,e,function(b){a.submitting=!1,b?a.unknownError=String(b.userMessage||b.developerMessage||b):a.status="success"})}}}]),angular.module("stormpathIdpApp").controller("VerifyCtrl",["$scope","Stormpath",function(a,b){a.status="loading",b.init.then(function(){b.verifyEmailToken(function(b){b?(a.status="failed",a.error=String(b.userMessage||b.developerMessage||b.message||b)):a.status="verified"})})}]),angular.module("stormpathIdpApp").controller("MfaSetupCtrl",["$location","$scope","$routeParams","Stormpath",function(a,b,c,d){b.account=d.getAccountFromSession(),b.factor=null,b.factors=[],b.challenge=null,b.googleAuthenticator={state:null,base64QRImage:null,code:null,factor:null},b.smsFactor={state:null,phoneNumber:null};var e={sms:{id:"sms",title:"SMS Text Messages",subTitle:"Your carrier's standard charges may apply."},"google-authenticator":{id:"google-authenticator",title:"Google Authenticator",subTitle:"A free app from Google."}};b.selectFactor=function(b){a.path("/mfa/setup/"+b)},b.verifyGoogleAuthenticatorCode=function(){var a={code:b.googleAuthenticator.code};d.createChallenge(b.factor,a,function(a,c){return a?(b.status="failed",void(b.error=String(a.userMessage||a.developerMessage||a.message||a))):"FAILED"===c.status?void(b.googleAuthenticator.state="invalid_code"):void d.mfaRedirectFromCallbackUrl("setup",c.serviceProviderCallbackUrl)})},b.createSmsFactor=function(){var c={type:"sms",phone:{number:b.smsFactor.phoneNumber}};d.createFactor(b.account,c,function(c){return c?13105===c.code?b.smsFactor.state="duplicate_phone_number":b.smsFactor.state="invalid_phone_number":void a.path("/mfa/verify/sms/true")})},b.status="loading",d.init.then(function(){if(d.client.requireMfa.forEach(function(a){if(a=a.toLowerCase(),a in e){var d=JSON.parse(JSON.stringify(e[a]));a===c.factor&&(b.factor=d),b.factors.push(d)}}),b.factor&&"google-authenticator"===b.factor.id){var a={type:"google-authenticator",issuer:d.makeId()};return d.createFactor(b.account,a,function(a,c){if(a)return b.status="failed",void(b.error=String(a.userMessage||a.developerMessage||a.message||a));for(var d in c)b.factor[d]=c[d];b.googleAuthenticator.factor=c,b.googleAuthenticator.base64QRImage=c.base64QRImage,b.status="loaded"})}b.status="loaded"})}]),angular.module("stormpathIdpApp").controller("MfaVerifyCtrl",["$location","$scope","$routeParams","Stormpath",function(a,b,c,d){b.account=d.getAccountFromSession(),b.factor=null,b.factors=[],b.challenge=null,b.otherFactorsAvailable=!1,b.factorId=c.factor,b.isFirstVerification="true"===c.firstVerification,b.verification={code:null,state:null};var e={sms:{id:"sms",title:"Send a Text Message",subTitle:"We'll send a code to {{phoneNumber}}."},"google-authenticator":{id:"google-authenticator",title:"Google Authenticator",subTitle:"View a code in the mobile app."}};b.selectFactor=function(b){a.path("/mfa/verify/"+b)},b.changeSmsPhoneNumber=function(){a.path("/mfa/setup/sms")},b.resendSmsCode=function(){d.createChallenge(b.factor,null,function(a,c){return a?(b.status="failed",void(b.error=String(a.userMessage||a.developerMessage||a.message||a))):(b.verification.state="resent_code",void(b.challenge=c))})},b.verifyCode=function(){var a={code:b.verification.code};d.updateChallenge(b.challenge,a,function(a,c){if(a)return b.status="failed",void(b.error=String(a.userMessage||a.developerMessage||a.message||a));if("FAILED"===c.status)return void(b.verification.state="invalid_code");var e=b.isFirstVerification?"setup":"verification";d.mfaRedirectFromCallbackUrl(e,c.serviceProviderCallbackUrl)})},b.status="loading",d.init.then(function(){var c={};d.client.requireMfa.forEach(function(a){c[a.toLowerCase()]=null}),b.otherFactorsAvailable=d.client.requireMfa.length>1,d.getFactors(b.account,function(f,g){return f?(b.status="failed",void(b.error=String(f.userMessage||f.developerMessage||f.message||f))):(g.items.forEach(function(a){if("ENABLED"===a.status&&("VERIFIED"===a.verificationStatus||b.isFirstVerification)){var d=a.type.toLowerCase();if(d in c){var f=JSON.parse(JSON.stringify(e[d]));for(var g in a)f[g]=a[g];"sms"===d&&(f.subTitle=f.subTitle.replace("{{phoneNumber}}",f.phone.number)),b.factorId===f.id&&(b.factor=f),b.factors.push(f)}}}),b.factors.length?(b.factor&&d.client.createChallenge(b.factor,function(a,c){b.challenge=c}),void(b.status="loaded")):a.path("/mfa/setup/"))})})}]),angular.module("stormpathIdpApp").controller("MfaRedirectCtrl",["$scope","$routeParams","Stormpath",function(a,b,c){function d(){c.ssoEndpointRedirect(a.jwt)}a.source=b.source,a.jwt=b.jwt,setTimeout(d,3e3)}]),angular.module("stormpathIdpApp").controller("ErrorCtrl",["$scope","Stormpath",function(a,b){a.errors=b.errors,a.inError=!1,a.$watchCollection("errors",function(){a.inError=a.errors.length>0})}]),angular.module("stormpathIdpApp").service("Stormpath",["$window","$routeParams","$location","$rootScope","$q",function(a,b,c,d,e){function f(a){var b=a.userMessage||a.developerMessage||a.message||"Unknown";j.errors.indexOf(b)===-1&&j.errors.push(b)}function g(a){return a.split("jwtResponse=")[1]}function h(b){a.location=b}function i(){return n&&n[1]&&parseInt(n[1],10)<10?void f(new Error("Internet Explorer "+n[1]+" is not supported.  Please try again with a newer browser.")):void(o=j.client=new m.Client(function(a,b){d.$apply(function(){if(a)f(a),k.reject(a);else{var e=b;j.idSiteModel=e,j.providers=j.providers.concat(e.providers),d.logoUrl=e.logoUrl,k.resolve(),j.getAccountFromSession()&&c.path("/mfa/verify")}})}))}var j=this,k=e.defer(),l=c.search(),m=a.Stormpath,n=a.navigator.userAgent.match(/MSIE ([0-9.]+)/),o=j.client=null;return j.init=k.promise,j.errors=[],j.jwt=l.jwt,j.isRegistered=null,j.providers=[],j.registeredAccount=null,j.isVerified=null,this.ssoEndpointRedirect=function(b){a.location=o.baseurl+"sso/?jwtResponse="+b},this.ssoEndpointRedirectFromUrl=function(a){var b=g(a);j.ssoEndpointRedirect(b)},this.mfaRedirectFromCallbackUrl=function(a,b){var d=g(b);c.path("/mfa/redirect/"+encodeURIComponent(a)+"/"+encodeURIComponent(d))},this.samlLogin=function(b,c){var d={method:"GET",url:j.client.appHref+"/saml/sso/idpRedirect?accountStore.href="+b.href};j.client.requestExecutor.execute(d,function(b,d){b?b.serviceProviderCallbackUrl?h(b.serviceProviderCallbackUrl):c(b):a.location=d.serviceProviderCallbackUrl})},this.getAccountFromSession=function(){var a=o.getSessionJwt(),b=a.body.scope.account;if(!b)return null;var c=Object.keys(b)[0],d=o.baseurl+"/v1/accounts/"+c;return{href:d}},this.login=function(a,b){var e={};o.requireMfa&&(e.redirect=!1),o.login(a,e,function(a,e){d.$apply(function(){if(a)return void(a.serviceProviderCallbackUrl?h(a.serviceProviderCallbackUrl):b(a));if(e&&e.serviceProviderCallbackUrl){var d=g(e.serviceProviderCallbackUrl);return j.ssoEndpointRedirect(d)}var f=o.getSessionJwt();if(!f)return b(new Error("Login failed. Did not receive a session JWT."));if(o.requireMfa){var i="setup";return Object.keys(f.body.scope.factor||{}).length>0&&(i="verify"),c.path("/mfa/"+i)}j.ssoEndpointRedirect(f.toString())})})},this.register=function(a,b){o.register(a,function(a,e){d.$apply(function(){if(a)return void(a.serviceProviderCallbackUrl?h(a.serviceProviderCallbackUrl):b(a));var d=o.getSessionJwt();if(d&&d.body.require_mfa)return c.path("/mfa/setup/");if(e&&e.serviceProviderCallbackUrl){var f=g(e.serviceProviderCallbackUrl);return j.ssoEndpointRedirect(f)}j.isRegistered=!0,c.path("/unverified")})})},this.verifyEmailToken=function(a){o.verifyEmailToken(function(b){d.$apply(function(){j.isVerified=!b,a(b)})})},this.verifyPasswordToken=function(a){o.verifyPasswordResetToken(function(b,c){d.$apply(function(){a(b,c)})})},this.sendPasswordResetEmail=function(a,b){o.sendPasswordResetEmail(a,function(a){d.$apply(function(){a?a.serviceProviderCallbackUrl?h(a.serviceProviderCallbackUrl):b(a):b()})})},this.setNewPassword=function(a,b,c){o.setAccountPassword(a,b,function(a,b){d.$apply(function(){c(a,b)})})},this.getFactors=function(a,b){o.getFactors(a,function(a,c){d.$apply(function(){b(a,c)})})},this.challengeFactor=function(a,b,c){o.challengeFactor(a,b,function(a,b){d.$apply(function(){c(a,b)})})},this.createFactor=function(a,b,c){o.createFactor(a,b,function(a,b){d.$apply(function(){c(a,b)})})},this.createChallenge=function(a,b,c){o.createChallenge(a,b,function(a,b){d.$apply(function(){c(a,b)})})},this.updateChallenge=function(a,b,c){o.updateChallenge(a,b,function(a,b){d.$apply(function(){c(a,b)})})},this.getOrganizationNameKey=function(){return o.jwtPayload.asnk||""},this.getProvider=function(a){var b=j.providers.filter(function(b){return b.providerId===a});return 1===b.length?b[0]:null},this.makeId=function(a){a=a||5;for(var b="",c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",d=0;d<a;d++)b+=c.charAt(Math.floor(Math.random()*c.length));return b},i(),this}]),angular.module("stormpathIdpApp").controller("RegistrationFormCtrl",["$scope","Stormpath",function(a,b){function c(a){var b=a||{};return String(b.message||b.userMessage||b.developerMessage||b)}a.fields={},a.submit=function(){a.knownError=a.unknownError=!1;var d=Object.keys(a.fields).filter(function(b){var c=a.fields[b];return c.validate()}),e=Object.keys(a.fields).reduce(function(b,c){return b[c]=a.fields[c].value,b},{});delete e.passwordConfirm,0===d.length&&(a.submitting=!0,b.register(e,function(b){a.submitting=!1,b&&(409===b.status?a.fields.email.setError("duplicateUser",!0):b.code?a.knownError=c(b):a.unknownError=c(b))}))}}]),angular.module("stormpathIdpApp").directive("formGroup",function(){return{restrict:"A",scope:!0,link:function(a,b,c){a.validationError=!1,a.errors={},a.$watch("validationError",function(){b.toggleClass(c.errorClass||"has-error",a.validationError)}),a.$watchCollection("errors",function(){var d=Object.keys(a.errors).filter(function(b){return a.errors[b]}).length;b.toggleClass(c.errorClass||"has-error",a.validationError||d>0)})}}}),angular.module("stormpathIdpApp").directive("formControl",function(){return{restrict:"A",link:function(a,b,c){var d=c.name;a.fields||(a.fields={}),a.fields[d]={value:b.val(),validationError:!1,errors:a.errors||{},setError:function(b,c){"function"==typeof a.setError&&a.setError(b,c)},validate:function(){return"function"!=typeof a.validate||a.validate(b)}},a.clearErrors=function(){Object.keys(a.errors).map(function(b){a.errors[b]=!1})},b.on("input",function(){a.$apply(function(a){a.fields[d].value=b.val()})}),a.$watchCollection("errors",function(b){angular.extend(a.fields[d].errors,b||{})}),a.$watchCollection("fields."+d+".errors",function(b){angular.extend(a.errors,b||{})})}}}),angular.module("stormpathIdpApp").directive("validateOnBlur",function(){return{restrict:"A",link:function(a,b){b.on("blur",function(){a.$apply(function(){a.validate(b)})})}}}),angular.module("stormpathIdpApp").directive("nameValidation",function(){return{restrict:"A",link:function(a){a.validate=function(b){a.clearErrors();var c=""===b.val();return a.validationError=c,c}}}}),angular.module("stormpathIdpApp").directive("emailValidation",function(){var a=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return{restrict:"A",link:function(b){b.errors={duplicateUser:!1},b.setError=function(a,c){b.errors[a]=c},b.validate=function(c){b.clearErrors();var d=c.val().trim(),e=""===d||!a.test(d);return b.validationError=e,e}}}}),angular.module("stormpathIdpApp").directive("passwordMatchValidation",function(){return{restrict:"A",link:function(a){a.validate=function(b){var c=""!==a.fields.password.value&&b.val()!==a.fields.password.value;return a.validationError=c,c}}}}),angular.module("stormpathIdpApp").directive("passwordPolicyValidation",["Stormpath",function(a){return{restrict:"A",link:function(b){b.errors={minLength:!1,maxLength:!1,requireLowerCase:!1,requireUpperCase:!1,requireNumeric:!1,requireDiacritical:!1},b.errorCount=function(){return Object.keys(b.errors).filter(function(a){return b.errors[a]}).length},b.validate=function(c){b.clearErrors();var d=c.val();if(a.idSiteModel.passwordPolicy){for(var e=[["minLength",function(){return d.length<a.idSiteModel.passwordPolicy.minLength}],["maxLength",function(){return d.length>a.idSiteModel.passwordPolicy.maxLength}],["requireLowerCase",function(){return a.idSiteModel.passwordPolicy.requireLowerCase&&!/[a-z]/.test(d)}],["requireUpperCase",function(){return a.idSiteModel.passwordPolicy.requireUpperCase&&!/[A-Z]/.test(d)}],["requireNumeric",function(){return a.idSiteModel.passwordPolicy.requireNumeric&&!/[0-9]/.test(d)}],["requireSymbol",function(){return a.idSiteModel.passwordPolicy.requireSymbol&&!/[!-\/:-@\[-`{-~]/.test(d)}],["requireDiacritical",function(){return a.idSiteModel.passwordPolicy.requireDiacritical&&!/[\u00C0-\u017F]/.test(d)}]],f=0;f<e.length&&(b.errors[e[f][0]]=e[f][1](d),!(b.errorCount()>0));f++);return b.validationError=b.errorCount()>0,b.validationError}}}}}]),angular.module("stormpathIdpApp").controller("UnverifiedCtrl",["$scope","Stormpath","$location",function(a,b,c){b.isRegistered||c.path("/")}]);